# deployment.yaml (用于 k8s-config-repo)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mydevops-app-deployment
  labels:
    app: mydevops
spec:
  # 您希望运行的 Pod 副本数量
  replicas: 2
  selector:
    matchLabels:
      app: mydevops
  template:
    metadata:
      labels:
        app: mydevops
    spec:
      containers:
      - name: mydevops-container
        # ✨ 关键点：这是 CI 脚本 (Step 7) 将会替换的字段！
        # 初始标签可以使用最新的稳定版本或 'latest'
        image: registry.cn-hangzhou.aliyuncs.com/my-devops-ns/my-devops-rep:7f61d008300b02eb0e785813c3a9e8bfea5cac5a

        ports:
        - containerPort: 8080
          name: http-web

        # 容器资源限制：限制 Java 进程的 CPU 和内存，防止资源耗尽
        resources:
          limits:
            memory: "1024Mi"
            cpu: "500m"
          requests:
            memory: "512Mi"
            cpu: "250m"

        # 优化：配置健康检查 (Liveness/Readiness Probes)
        # 确保 Kubernetes 不会向未准备好的 Pod 发送流量，并自动重启不健康的 Pod。
        # 如果您的 Spring Boot 应用使用了 Actuator，可以直接用 /actuator/health
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 120 # 启动时间长，延迟启动检查
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10

---
# Service YAML (推荐放在同一文件或同目录下)
apiVersion: v1
kind: Service
metadata:
  name: mydevops-service
spec:
  # ClusterIP 类型，供集群内部和 Ingress 访问
  type: ClusterIP
  selector:
    app: mydevops # 必须匹配 Deployment 的 labels
  ports:
    - port: 80 # Service 暴露的端口 (供 Ingress 访问)
      targetPort: 8080 # 转发到容器的 8080 端口
      protocol: TCP

---
# Ingress YAML (推荐放在同一文件或同目录下)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mydevops-ingress
  # 确保 k3s 的 Traefik 识别这个 Ingress
  annotations:
    ingress.kubernetes.io/ssl-redirect: "false"
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mydevops-service # 指向上面定义的 Service
            port:
              number: 80 # Service 的端口